<!DOCTYPE html>
<html lang="de-de">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<style type=text/css>body{font-family:monospace;}</style>
	<title>LED Wanduhr</title>
	<meta name="description" content="Personal blog">
	<meta name="author" content="Manfred Caspar">
	<link rel="stylesheet" href="/css/style.css">
	
	
</head>
<body>
	<header>
	------<br>
	  <a href="http://22x22.de/">mancas</a> <br>
	------
	<div style="float: right;"></div><br>
	<p>
	<nav>
			<a href="/"><b>Start</b></a>.
			
			
			<a href="/posts/"><b>Laufendes Projekt</b></a>.
			
			<a href="/%C3%BCber-diese-seite/about"><b>Über diese Seite</b></a>.
			
	</nav>
	</p>
	
</header>

	
	<main>
		<article>
			<h1>LED Wanduhr</h1>
			<b><time>2020-05-16 10:10:10</time></b>
		       

			<div>
				<h3 id="hängt-fertig-an-der-wand">Hängt fertig an der Wand!</h3>
<p>Marco hatte diese Uhr nach einer Idee von bastelgarage.ch Donnerstags zu unserem Linux Vereinstreffen mitgebracht.<br />
<a href="https://www.youtube.com/watch?v=BMY3TZdeMGw">https://www.youtube.com/watch?v=BMY3TZdeMGw</a></p>
<p>Das machte Lust dieses Projekt nachzubauen, da es ein schönes Beispiel ist für:</p>
<ul>
<li>Code schreiben für den ESP8266</li>
<li>Ansteuerung einer 8x8-LED Anzeige</li>
<li>Text rollt über die Anzeige</li>
<li>Einwählen ins WLAN</li>
<li>Uhrzeit wird vom Zeitserver abgeholt</li>
<li>Wetter kommt von openweathermap.org</li>
<li>Variablen für den Programmcode werden aus einem Json-File aufbereitet</li>
</ul>
<p>Gut zum Lernen und ausbaufähig zum kreativen Umsetzen mit eigenen Ergänzungen im Code.</p>
<p><img src="/images/LED-Uhr/LED-Uhr-Orig.jpg" alt="LED-Uhr-Orig" /></p>
<!-- blank line -->
<br>
<br>
<br>
<!-- blank line -->
<h2 id="macht-sich-gut-in-einem-schönen-gehäuse">Macht sich gut in einem schönen Gehäuse!</h2>
<p><img src="/images/LED-Uhr/LED-Uhr-Zeit.jpg" alt="LED-Uhr-Zeit" /></p>
<p><img src="/images/LED-Uhr/LED-Uhr-Innen.jpg" alt="LED-Uhr-Innen" /></p>
<!-- blank line -->
<br>
<br>
<br>
<!-- blank line -->
<h2 id="so-wird-angepasst">So wird angepasst</h2>
<p>Die Wetteranzeige hatte bei mir leider nicht funktionniert. Daher wurde das Script auf die Library ESP8266HTTP umgestellt.</p>
<pre tabindex="0"><code>// Modifiziertes Script von https://techtutorialsx.com/2016/07/17/esp8266-http-get-requests/
// replaces getWeatherData()

// added by mancas
// #include &lt;ESP8266WiFi.h&gt;
// #include &lt;ESP8266HTTPClient.h&gt;
 

void getMetarData ()  {
String line;
 
if (WiFi.status() == WL_CONNECTED) { //Check WiFi connection status
 
HTTPClient http;  //Declare an object of class HTTPClient
 
http.begin(&#34;http://api.openweathermap.org/data/2.5/weather?id=xxxx&amp;units=metric&amp;appid=xxxxxx&amp;lang=de&#34;);  //Specify request destination

int httpCode = http.GET();                                                                  //Send the request
Serial.print(&#34; - httpCode is &#34;);
Serial.println(httpCode);
 
if (httpCode &gt; 0) { //Check the returning code
 
String payload = http.getString();   //Get the request response payload

Serial.print(&#34; - Response from Server &#34;);
Serial.println(payload);                     //Print the response payload


line += payload; // to let the rest of the script untouched
Serial.println(line);
 

http.end();   //Close connection
}

// Allocate JsonBuffer  // Leh
  // Use arduinojson.org/assistant to compute the capacity.
  const size_t capacity = JSON_ARRAY_SIZE(2) + JSON_OBJECT_SIZE(1) + 2*JSON_OBJECT_SIZE(2) + 2*JSON_OBJECT_SIZE(4) + JSON_OBJECT_SIZE(5) + JSON_OBJECT_SIZE(6) + JSON_OBJECT_SIZE(12) + 420;
  DynamicJsonBuffer jsonBuf(capacity);
  
//  DynamicJsonBuffer jsonBuf;
  JsonObject &amp;root = jsonBuf.parseObject(line);
  if (!root.success())
  {
    Serial.println(&#34;parseObject() failed&#34;);
    return;
  }
  //weatherMain = root[&#34;weather&#34;][&#34;main&#34;].as&lt;String&gt;();
  weatherDescription = root[&#34;weather&#34;][&#34;description&#34;].as&lt;String&gt;();
  weatherDescription.toLowerCase();
  //  weatherLocation = root[&#34;name&#34;].as&lt;String&gt;();
  //  country = root[&#34;sys&#34;][&#34;country&#34;].as&lt;String&gt;();
  temp = root[&#34;main&#34;][&#34;temp&#34;];
  humidity = root[&#34;main&#34;][&#34;humidity&#34;];
  pressure = root[&#34;main&#34;][&#34;pressure&#34;];
  tempMin = root[&#34;main&#34;][&#34;temp_min&#34;];
  tempMax = root[&#34;main&#34;][&#34;temp_max&#34;];
  windSpeed = root[&#34;wind&#34;][&#34;speed&#34;];
  windDeg = root[&#34;wind&#34;][&#34;deg&#34;];
  clouds = root[&#34;clouds&#34;][&#34;all&#34;];
  
 getTimeLocal();

  String windDirection = &#34;N NOO SOS SWW NW&#34;;  // Windrichtungen N NO O SO S SW W NW immer 2 char lang
  int wr = (windDeg+22)%360/45;
//  Serial.println(wr);

  String dayName[] = {&#34;Err&#34;, &#34;Sonntag&#34;, &#34;Montag&#34;, &#34;Dienstag&#34;, &#34;Mittwoch&#34;, &#34;Donnerstag&#34;, &#34;Freitag&#34;, &#34;Samstag&#34;};

// For test purposes
// String(d) = &#34;25&#34;;
// String(m) = &#34;5&#34;;
// w = 2; // was monday in year 2020
  
  String deg = String(char(&#39;~&#39; + 25));
  String arrowUp = String(char(&#39;~&#39; + 23));
  
  if (String(d) == &#34;25&#34; and String(mo) == &#34;5&#34;) {
    weatherString = &#34;       &#34; + dayName[w]  + &#34;  &#34; + String(d) + &#34;.&#34; + String(mo) + &#34;.  Towel Day!      &#34;;
  } else {
    weatherString = &#34;       &#34; + dayName[w]  + &#34;  &#34; + String(d) + &#34;.&#34; + String(mo) + &#34;.&#34; + String(ye) + &#34;     &#34;;
  }
  weatherString +=   String(temp, 1) + deg + &#34;C &#34;;
  weatherString += &#34;  Luftf.: &#34; + String(humidity) + &#34;%  &#34;;  // Luftfeuchtigkeit
  weatherString += &#34;  Luftd: &#34; + String(pressure) + &#34;hPa  &#34;; // Luftdruck
  weatherString += &#34;  Regenrisiko: &#34; + String(clouds) + &#34;%  &#34;; // Regenrisiko
//  weatherString += &#34;  Wind: &#34; + String(windSpeed, 1) + &#34;m/s                &#34;; // Windgeschwindigkeit
  weatherString += &#34;  Wind: &#34; + String(windSpeed, 1) + &#34;m/s  &#34;; // Windgeschwindigkeit
  weatherString += String(windDeg) + deg + &#34;  &#34;;
  weatherString +=  arrowUp + &#34;  &#34; + windDirection.substring(2*wr,2*wr+2) + &#34;    &#34;; // Windgeschwindigkeit und Richtung
  Serial.println(weatherString);  //Leh
}

} 
</code></pre><p><img src="/images/LED-Uhr/LED-Uhr-Wetter.jpg" alt="LED-Uhr-Wetter-mp4" /></p>
<!-- blank line -->
<br>
<br>
<br>
<!-- blank line -->
<h2 id="towel-day">Towel Day</h2>
<p>Die Uhr kann natürlich auch an Geburtstage und andere wichtige Termine erinnern. Eine einfache Abfrage im Script machts möglich. Das Beispiel für den Nerd: Towel Day am 25.05. ist in obigem Script eingebaut.</p>
<!-- blank line -->
<br>
<br>
<br>
<!-- blank line -->
<h2 id="live-anzeige-vom-textserver">Live Anzeige vom Textserver</h2>
<p>Andere Variante für Live-Anzeige: In meinem Laptop habe ich einen Webserver aufgesetzt. Dieser wird abgefragt und der dort gepostete Satz angezeigt.</p>
<pre tabindex="0"><code>void getLocalWebData ()  {

String Line;

if (WiFi.status() == WL_CONNECTED) { //Check WiFi connection status
 
HTTPClient http;  //Declare an object of class HTTPClient
 
http.begin(&#34;http://192.168.63.6&#34;);  //Specify request destination

int httpCode = http.GET();                                                                  //Send the request
Serial.print(&#34; - httpCode is &#34;);
Serial.println(httpCode);
 
if (httpCode &gt; 0) { //Check the returning code
 
Line = http.getString();   //Get the request response payload

Serial.print(&#34; - Response from localWebServer &#34;);
Serial.println(Line);                     //Print the response payload

WebLine = &#34;  &#34; + Line + &#34;   &#34;;

http.end();   //Close connection

}
}
   
getTimeLocal();
  
Serial.println(WebLine);  //Leh
}
</code></pre><!-- blank line -->
<br>
<br>
<br>
<!-- blank line -->
<h3 id="zum-abschluß-eine-wortuhr">Zum Abschluß eine Wortuhr</h3>
<p>Schließlich wurde die Uhr auf reine Textanzeige umgestellt. Die Anzeige ist für Slowdown-Nerds: &ldquo;Es ist so viertel nach Zehn&rdquo; ist ein Beispiel dazu.</p>
<!-- blank line -->
<figure class="video_container">
  <video controls="true" allowfullscreen="true" poster="/images/LED-Uhr/Wortuhr.jpg">
    <source src="/images/LED-Uhr/Wortuhr.mp4" type="video/mp4">
    </video>
</figure>
<!-- blank line -->
<pre tabindex="0"><code>//Sprachausgabe der Uhrzeit

int Stunde;
String MinutenText;
String StundenText;

void WordClock () {

  getTimeLocal();
  Serial.println(&#34;Wordclock &#34;);
 if (h &gt; 12) {Stunde = h-12;} else {Stunde = h;} 
  
//  Serial.print(Stunde); Serial.print(&#34; : &#34;); Serial.println(m);

 if (m == 0) {MinutenText = &#34;genau &#34;;}
 if (m &gt; 0)  {MinutenText = &#34;kurz nach &#34;;}
 if (m &gt; 2)  {MinutenText = &#34;funf nach &#34;;}
 if (m &gt; 7)  {MinutenText = &#34;zehn nach &#34;;}
 if (m &gt; 12) {MinutenText = &#34;viertel nach  &#34;;}
 if (m &gt; 17) {MinutenText = &#34;zwanzig nach &#34;;}
 if (m &gt; 22) {MinutenText = &#34;funf vor halb &#34;; Stunde = Stunde + 1;}
 if (m &gt; 27) {MinutenText = &#34;halb &#34;;}
 if (m &gt; 32) {MinutenText = &#34;funf nach halb &#34;;}
 if (m &gt; 37) {MinutenText = &#34;zwanzig vor &#34;;}
 if (m &gt; 42) {MinutenText = &#34;viertel vor &#34;;}
 if (m &gt; 47) {MinutenText = &#34;zehn vor &#34;;}
 if (m &gt; 52) {MinutenText = &#34;funf vor &#34;;}
 if (m &gt; 57) {MinutenText = &#34;gleich &#34;;}

 if (Stunde == 1) {StundenText = &#34;eins&#34;;}
 if (Stunde == 2) {StundenText = &#34;zwei&#34;;}
 if (Stunde == 3) {StundenText = &#34;drei&#34;;}
 if (Stunde == 4) {StundenText = &#34;vier&#34;;}
 if (Stunde == 5) {StundenText = &#34;funf&#34;;}
 if (Stunde == 6) {StundenText = &#34;sechs&#34;;}
 if (Stunde == 7) {StundenText = &#34;sieben&#34;;}
 if (Stunde == 8) {StundenText = &#34;acht&#34;;}
 if (Stunde == 9) {StundenText = &#34;neun&#34;;}
 if (Stunde == 10) {StundenText = &#34;zehn&#34;;}
 if (Stunde == 11) {StundenText = &#34;elf&#34;;}
 if (Stunde == 12) {StundenText = &#34;zwolf&#34;;}

 
// Serial.print(MinutenText);
// Serial.println(StundenText);

TimeString = &#34;                    Es ist so &#34; + MinutenText + StundenText + &#34;                                      &#34;;
Serial.println(TimeString); 

}
</code></pre><!-- blank line -->
<br>
<br>
<br>
<!-- blank line -->
<h3 id="viel-spaß-beim-mitmachen-wünscht-mancas">Viel Spaß beim Mitmachen wünscht mancas!</h3>

			</div>
		</article>
	</main>
<aside>
	<div>
		<div>
			<h3>LATEST POSTS</h3>
		</div>
		<div>
			<ul>
				
				<li><a href="/posts/webradio/">WebRadio</a></li>
				
				<li><a href="/posts/3d-druck/">3D-Druck</a></li>
				
				<li><a href="/posts/stencil3ddruck/">3D-Druck eines Stencil-Halters</a></li>
				
				<li><a href="/posts/laserscan/">3D Laser Scanner</a></li>
				
				<li><a href="/posts/wlanrelais/">WLanRelais</a></li>
				
			</ul>
		</div>
	</div>
</aside>


	<footer>
	<p>&copy; 2022 <a href="http://22x22.de/"><b>mancas</b></a>.
	<a href="/impressum/impressum"><b>Impressum</b></a>.
	</p>
</footer>

</body>
</html>
